IntelliJ Core, UAST and Kotlin
------------------------------

Originally, we just downloaded snapshots of intellij-core itself from
https://www.jetbrains.com/intellij-repository/releases, like this:
https://www.jetbrains.com/intellij-repository/releases/com/jetbrains/intellij/idea/intellij-core/171.4249.32/intellij-core-171.4249.32.zip

The version number here, 171.3780.107, matches the IDE used in Studio,
defined in tools/idea/build.txt

However, when we added Kotlin support, it turns out that the Kotlin
compiler itself includes large portions of intellij-core (though thanks
to shrinking it was sometimes only partial classes). Since we need
the Kotlin compiler, we just turn off shrinking in the compiler build
and then drop in the compiler jar (which contains all of intellij-core).


Updating
--------

First, clone a copy of the Kotlin git repository:
$ git clone https://github.com/JetBrains/kotlin
(or to start a new branch, git checkout -t origin/master -b my-master)

Then switch to a compatible patch branch.

Currently:
$ git checkout 1.4.0
$ bunch switch 202

Verify that the file gradle/versions.properties has the line
    versions.intellijSdk=<VERSION>
and set <VERSION> to match the one in tools/idea/build.txt,
or a later version if there are no binary compatibility
issues (recall that Lint still has to link with Studio's platform
version when running in the IDE).

(Currently using 202.5103-EAP-CANDIDATE-SNAPSHOT)

Next cherry pick some fixes from upstream:
    fa8c6e7fb6: Uast: KT-40578: resolve Kotlin property writes to setters (#3597)
    27c139926c: LightClass improved isInheritor check for cases when resolve is failed (KT-37210)

Then make sure to apply some extra patches to work around bugs:
$ git apply /path/to/kotlin-compiler-patch.diff (which is located in this directory).

Note: if the patch does not apply cleanly, you can use the --3way
flag to fall back to a merge. Just be sure to update the patch file
after resolving conflicts.

Next, build the Kotlin repository:
$ ./gradlew dist :plugins:uast-kotlin:jar

Finally, run the update.xml script, pointing back to the Kotlin repository:
ant -f update.xml -Dkotlin_src_dir=$MY_KOTLIN_REPO_ROOT

The packaging script will extract code and update the intellij-core and uast prebuilts
in this directory. It performs a number of steps to do that, such as unbundling the
trove classes, replacing a platform icons class, etc.

Debugging
---------

To download the sources, grab the sources using the same version as the
one UAST was built from, e.g. for 193.6015.22-EAP-SNAPSHOT, use
https://www.jetbrains.com/intellij-repository/snapshots/com/jetbrains/intellij/idea/ideaIC/193.6015.22-EAP-SNAPSHOT/ideaIC-193.6015.22-EAP-SNAPSHOT-sources.jar
